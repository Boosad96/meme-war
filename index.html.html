<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meme War</title>
  <script src="https://unpkg.com/@wagmi/core@0.10.0/dist/index.umd.js"></script>
  <script src="https://unpkg.com/wagmi@0.10.0/dist/index.umd.js"></script>
  <script src="https://unpkg.com/@rainbow-me/rainbowkit@1.0.3/dist/index.umd.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@rainbow-me/rainbowkit@1.0.3/dist/index.css" />
  <style>
    body { font-family: system-ui, sans-serif; padding: 20px; text-align: center; }
    .meme-preview { position: relative; width: 100%; max-width: 500px; margin: 20px auto; }
    .top-text, .bottom-text { 
      position: absolute; left: 0; width: 100%; 
      font-weight: bold; color: white; 
      text-shadow: 2px 2px 4px black, -2px -2px 4px black; 
      font-size: 24px; 
    }
    .top-text { top: 10px; text-align: top; }
    .bottom-text { bottom: 10px; text-align: bottom; }
    button { padding: 12px 24px; background: #000; color: #fff; border: none; border-radius: 6px; font-size: 16px; margin: 10px; cursor: pointer; }
    input { display: block; margin: 10px auto; padding: 8px; width: 80%; max-width: 400px; }
    #imagePreview { max-width: 100%; max-height: 400px; margin: 10px auto; display: block; }
  </style>
</head>
<body>
  <h1>Meme War</h1>
  <p>Make a meme. Mint it. Own the chaos.</p>

  <input type="file" id="imageUpload" accept="image/*" />
  <input type="text" id="topText" placeholder="Top text" />
  <input type="text" id="bottomText" placeholder="Bottom text" />

  <div class="meme-preview">
    <img id="imagePreview" src="" style="display: none;" />
    <p class="top-text" id="topTextPreview"></p>
    <p class="bottom-text" id="bottomTextPreview"></p>
  </div>

  <button onclick="connectWallet()">Connect Wallet</button>
  <button onclick="mintMeme()">Post Meme</button>

  <script>
    let signer;
    const yourAddress = "0xa21e4999e6e9c7f62b7eeda4ae82e476530fa5a9"; // âœ… YOUR ADDRESS

    async function connectWallet() {
      const { createConfig, http } = wagmi;
      const { mainnet, zora } = wagmi.chains;
      const config = createConfig({
        chains: [zora],
        transports: { [zora.id]: http() },
      });
      const { getSigner } = wagmi;
      try {
        await window.rainbowkit.connect();
        signer = await getSigner(config);
        alert("Wallet connected!");
      } catch (e) {
        console.error(e);
        alert("Failed to connect");
      }
    }

    async function mintMeme() {
      if (!signer) return alert("Connect wallet first");
      const file = document.getElementById("imageUpload").files[0];
      if (!file) return alert("Upload an image");

      const formData = new FormData();
      const metadata = {
        name: "Meme War Entry",
        description: document.getElementById("topText").value + " " + document.getElementById("bottomText").value,
        content: document.getElementById("topText").value + "\n" + document.getElementById("bottomText").value,
        attributes: [{ trait_type: "platform", value: "memewar" }]
      };
      const blob = new Blob([JSON.stringify(metadata)], { type: "application/json" });
      formData.append("file", blob, "metadata.json");
      formData.append("file", file);

      // Upload to web3.file
      const res = await fetch("https://web3.file/api/upload", {
        method: "POST",
        body: formData,
      });
      const data = await res.json();
      const tokenURI = `ipfs://${data.path}`;

      // Mint on Zora
      const createMedia = async (params) => {
        const tx = await signer.sendTransaction({
          to: "0x3F323852f47B27d3473b829Ac38957392479c309", // Zora Media Contract
          data: `0x${Buffer.from(
            JSON.stringify({
              params: { tokenURI, creatorAddress: yourAddress },
            })
          ).toString("hex")}`,
        });
        return tx;
      };

      try {
        await createMedia({ tokenURI, creatorAddress: yourAddress });
        alert("Meme minted! Check your Zora profile.");
      } catch (err) {
        console.error(err);
        alert("Mint failed");
      }
    }

    document.getElementById("imageUpload").onchange = (e) => {
      const url = URL.createObjectURL(e.target.files[0]);
      document.getElementById("imagePreview").src = url;
      document.getElementById("imagePreview").style.display = "block";
    };
    document.getElementById("topText").oninput = (e) => {
      document.getElementById("topTextPreview").innerText = e.target.value;
    };
    document.getElementById("bottomText").oninput = (e) => {
      document.getElementById("bottomTextPreview").innerText = e.target.value;
    };
  </script>
</body>
</html>