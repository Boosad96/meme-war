import { useState } from "react";
import { ConnectButton } from "@rainbow-me/rainbowkit";
import "@rainbow-me/rainbowkit/styles.css";
import { useAccount, useSigner } from "wagmi";
import { createMedia } from "@zoralabs/zdk";

export default function Home() {
  const { isConnected } = useAccount();
  const { data: signer } = useSigner();
  const [image, setImage] = useState(null);
  const [topText, setTopText] = useState("");
  const [bottomText, setBottomText] = useState("");
  const [isMinting, setIsMinting] = useState(false);
  const [showModal, setShowModal] = useState(false);

  const handleImage = (e) => {
    const file = e.target.files[0];
    if (file) {
      const url = URL.createObjectURL(file);
      setImage(url);
    }
  };

  const uploadToIPFS = async (metadata) => {
    const blob = new Blob([JSON.stringify(metadata)], { type: "application/json" });
    const file = new File([blob], "metadata.json");
    const formData = new FormData();
    formData.append("file", file);
    const res = await fetch("https://web3.file/api/upload", {
      method: "POST",
      body: formData,
    });
    const data = await res.json();
    return `ipfs://${data.path}`;
  };

  const mintMeme = async () => {
    if (!signer) return alert("Wallet not connected");
    if (!image) return alert("Upload an image");
    setIsMinting(true);

    const metadata = {
      name: "Meme War Entry",
      description: `${topText} ${bottomText}`.trim(),
      content: `${topText}\n${bottomText}`,
      media: [],
      attributes: [{ trait_type: "platform", value: "memewar" }],
    };

    try {
      const tokenURI = await uploadToIPFS(metadata);
      await createMedia({
        chain: "zora",
        params: {
          tokenURI,
          creatorAddress: "0xa21e4999e6e9c7f62b7eeda4ae82e476530fa5a9", // ‚úÖ YOUR ADDRESS
        },
        options: {
          signer,
          createMediaTx: true,
        },
      });
      alert("üî• Meme minted! Check your Zora profile.");
    } catch (err) {
      console.error(err);
      alert("Mint failed. Try again.");
    } finally {
      setIsMinting(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-pink-300 via-purple-300 to-indigo-400 flex flex-col items-center px-4 py-8 font-sans">
      {/* Header */}
      <div className="text-center max-w-2xl mb-6">
        <h1 className="text-5xl font-extrabold text-white drop-shadow-lg mb-2">
          MEME WAR
        </h1>
        <p className="text-white text-xl opacity-90">Make a meme. Mint it. Own the chaos.</p>
      </div>

      {/* How It Works Button */}
      <button
        onClick={() => setShowModal(true)}
        className="mb-6 text-white underline text-lg hover:text-yellow-200 transition"
      >
        ü§î How It Works?
      </button>

      {/* Connect Wallet */}
      <div className="w-full max-w-md mb-6">
        <ConnectButton />
      </div>

      {/* Meme Editor */}
      {isConnected && (
        <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md">
          <input type="file" accept="image/*" onChange={handleImage} className="w-full mb-4" />

          <input
            placeholder="Top text"
            value={topText}
            onChange={(e) => setTopText(e.target.value.toUpperCase())}
            className="w-full mb-2 p-3 border-2 border-gray-300 rounded-lg text-center font-bold text-lg"
          />
          <input
            placeholder="Bottom text"
            value={bottomText}
            onChange={(e) => setBottomText(e.target.value.toUpperCase())}
            className="w-full mb-4 p-3 border-2 border-gray-300 rounded-lg text-center font-bold text-lg"
          />

          {image && (
            <div className="relative mb-4 border-4 border-yellow-400 rounded-lg overflow-hidden">
              <img src={image} alt="meme preview" className="w-full" style={{ maxHeight: 400 }} />
              <p className="absolute top-2 left-0 right-0 text-center font-bold text-white drop-shadow-2xl text-2xl">
                {topText}
              </p>
              <p className="absolute bottom-2 left-0 right-0 text-center font-bold text-white drop-shadow-2xl text-2xl">
                {bottomText}
              </p>
            </div>
          )}

          <button
            onClick={mintMeme}
            disabled={isMinting || !image}
            className="w-full bg-gradient-to-r from-red-500 to-pink-600 text-white py-3 rounded-xl font-bold text-lg hover:from-red-600 hover:to-pink-700 disabled:opacity-60 transition"
          >
            {isMinting ? "üöÄ Minting..." : "üí• POST MEME"}
          </button>
        </div>
      )}

      {/* How It Works Modal */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl p-8 max-w-md text-center shadow-2xl">
            <h2 className="text-3xl font-bold text-gray-800 mb-4">üéØ How It Works</h2>
            <ol className="text-left text-gray-700 space-y-3 mb-6">
              <li>
                <strong>1.</strong> Connect your wallet (MetaMask, Rainbow, etc.)
              </li>
              <li>
                <strong>2.</strong> Upload a meme image
              </li>
              <li>
                <strong>3.</strong> Add top & bottom text
              </li>
              <li>
                <strong>4.</strong> Click ‚ÄúPOST MEME‚Äù
              </li>
              <li>
                <strong>5.</strong> It mints as an NFT on Zora under your name!
              </li>
            </ol>
            <p className="text-sm text-gray-500 mb-6">
              Powered by Zora Network ‚Äî gasless, fast, on-chain forever.
            </p>
            <button
              onClick={() => setShowModal(false)}
              className="bg-black text-white px-6 py-2 rounded-full hover:bg-gray-800 transition"
            >
              Got it!
            </button>
          </div>
        </div>
      )}

      {/* Footer */}
      <p className="text-white text-sm mt-8 opacity-80">
        Run by{" "}
        <a
          href="https://zora.co/@0xa21e4999e6e9c7f62b7eeda4ae82e476530fa5a9"
          target="_blank"
          className="underline hover:text-yellow-200"
        >
          your Zora profile
        </a>
      </p>
    </div>
  );
}
